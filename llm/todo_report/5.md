
## ğŸ“‹ å·¥ä½œæ—¥èªŒ #005

**ä»»å‹™**: ç’°å¢ƒæª¢æ¸¬ç³»çµ±å¯¦ç¾  
**æ—¥æœŸ**: 2025-05-25  
**å„ªå…ˆç´š**: ğŸ”´ High  
**ç‹€æ…‹**: âœ… å®Œæˆ

### ğŸ¯ å®Œæˆå…§å®¹

1. **æ ¸å¿ƒç’°å¢ƒæª¢æ¸¬ (src/utils/environment.ts)**
   - **å¤šç’°å¢ƒæ”¯æ´**: Browser, Node.js, WebWorker, Unknown
   - **æ™ºèƒ½æª¢æ¸¬é‚è¼¯**: æŒ‰å„ªå…ˆé †åºæª¢æ¸¬ç’°å¢ƒé¡å‹
   - **åŠŸèƒ½ç‰¹æ€§æª¢æ¸¬**: localStorage, crypto, performance ç­‰ API
   - **éŒ¯èª¤å®¹éŒ¯**: åš´æ ¼ç’°å¢ƒä¸‹çš„ç•°å¸¸è™•ç†
   - **æ•ˆèƒ½å„ªåŒ–**: å¿«é€Ÿæª¢æ¸¬å’Œçµæœå¿«å–

2. **å®Œæ•´æ¸¬è©¦è¦†è“‹ (src/utils/__tests__/environment.test.ts)**
   - **ç€è¦½å™¨ç’°å¢ƒæ¸¬è©¦**: jsdom ç’°å¢ƒä¸‹çš„å®Œæ•´é©—è­‰
   - **é‚Šç•Œæƒ…æ³æ¸¬è©¦**: ç¼ºå¤±å…¨åŸŸè®Šæ•¸ã€è¨ªå•ç•°å¸¸è™•ç†
   - **åŠŸèƒ½æª¢æ¸¬æ¸¬è©¦**: å„ç¨® API å¯ç”¨æ€§é©—è­‰
   - **æ¢ä»¶åŸ·è¡Œæ¸¬è©¦**: ç’°å¢ƒç‰¹å®šä»£ç¢¼åŸ·è¡Œ
   - **æ•ˆèƒ½æ¸¬è©¦**: æª¢æ¸¬é€Ÿåº¦é©—è­‰

3. **Node.js å°ˆç”¨æ¸¬è©¦ (tests/node/environment.test.ts)**
   - **ç´” Node.js ç’°å¢ƒ**: ç§»é™¤ç€è¦½å™¨ç’°å¢ƒæ¨¡æ“¬
   - **æœå‹™ç«¯ç‰¹æ€§é©—è­‰**: Node.js ç‰ˆæœ¬ã€å¹³å°è³‡è¨Š
   - **API å¯ç”¨æ€§æ¸¬è©¦**: crypto, perf_hooks, fetch æª¢æ¸¬
   - **æ•ˆèƒ½åŸºæº–æ¸¬è©¦**: 1000 æ¬¡æª¢æ¸¬ < 10ms
   - **éŒ¯èª¤è™•ç†æ¸¬è©¦**: process ç‰©ä»¶ç¼ºå¤±è™•ç†

4. **Logger ç³»çµ± (src/utils/logger.ts)**
   - **åˆ†ç´šæ—¥èªŒ**: debug, info, warn, error, silent
   - **ç’°å¢ƒè‡ªé©æ‡‰**: æ ¹æ“šç’°å¢ƒå„ªåŒ–è¼¸å‡ºæ ¼å¼
   - **çµæ§‹åŒ–æ—¥èªŒ**: JSON æ ¼å¼æ”¯æ´
   - **æ•ˆèƒ½ç›£æ§**: è¨ˆæ™‚å™¨å’Œæ•ˆèƒ½æ¸¬é‡å·¥å…·
   - **æ¢ä»¶è¨˜éŒ„**: é–‹ç™¼/ç”Ÿç”¢ç’°å¢ƒç‰¹å®šæ—¥èªŒ

5. **æ¨¡çµ„æ•´åˆ (src/utils/index.ts)**
   - **çµ±ä¸€å°å‡º**: ç’°å¢ƒæª¢æ¸¬å’Œ Logger çš„å®Œæ•´ API
   - **é¡å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript é¡å‹å®šç¾©
   - **å¥åº·æª¢æŸ¥**: æ¨¡çµ„é‹ä½œç‹€æ…‹é©—è­‰
   - **ç‰ˆæœ¬ç®¡ç†**: æ¨¡çµ„ç‰ˆæœ¬è¿½è¹¤

### ğŸ” é—œéµç‰¹æ€§

1. **æ™ºèƒ½ç’°å¢ƒæª¢æ¸¬ç®—æ³•**
```typescript
// æª¢æ¸¬é †åºï¼šWebWorker â†’ Node.js â†’ Browser â†’ Unknown
const detectEnvironment = (): Environment => {
  if (typeof self !== 'undefined' && typeof importScripts === 'function') {
    return 'webworker';
  }
  if (typeof process !== 'undefined' && process.versions?.node) {
    return 'node';
  }
  if (typeof window !== 'undefined' && typeof document !== 'undefined') {
    return 'browser';
  }
  return 'unknown';
};
```

2. **æ¢ä»¶åŸ·è¡Œæ©Ÿåˆ¶**
```typescript
// ç’°å¢ƒç‰¹å®šä»£ç¢¼åŸ·è¡Œ
runInBrowser(() => {
  // åƒ…åœ¨ç€è¦½å™¨ä¸­åŸ·è¡Œ
  const signal = store.select(state => state.data);
}, () => {
  // æœå‹™ç«¯å›é€€é‚è¼¯
  const observable = store.state$.pipe(map(state => state.data));
});
```

3. **ç›¸å®¹æ€§æª¢æŸ¥ç³»çµ±**
```typescript
const compatibility = checkCompatibility({
  environments: ['browser', 'node'],
  features: ['hasPromises', 'hasCrypto']
});
if (!compatibility.compatible) {
  console.warn('Missing requirements:', compatibility.missing);
}
```

4. **æ•ˆèƒ½å„ªåŒ–çš„ Logger**
```typescript
// æ—©æœŸè¿”å›é¿å…ä¸å¿…è¦çš„è¨ˆç®—
if (!this.isEnabled(level)) {
  return; // ç´šåˆ¥ä¸ç¬¦ç›´æ¥è¿”å›
}
```

### âœ… é©—æ”¶æ¨™æº–é”æˆ

- [x] browser/node/webworker ç’°å¢ƒæ­£ç¢ºè­˜åˆ¥
- [x] isBrowser/isServer å‡½æ•¸å¯ç”¨ä¸”æº–ç¢º
- [x] å„ç’°å¢ƒ API ç‰¹æ€§æ­£ç¢ºæª¢æ¸¬
- [x] éŒ¯èª¤å®¹éŒ¯æ©Ÿåˆ¶å®Œå–„
- [x] æ¸¬è©¦è¦†è“‹ç‡é”åˆ°è¦æ±‚æ¨™æº–

### ğŸš€ ç’°å¢ƒæª¢æ¸¬èƒ½åŠ›

| ç’°å¢ƒ | æª¢æ¸¬ç‰¹å¾µ | æ”¯æ´åŠŸèƒ½ |
|------|----------|----------|
| Browser | window + document | DOM, WebAPIs, localStorage |
| Node.js | process.versions.node | æª”æ¡ˆç³»çµ±, crypto, ç¶²è·¯ |
| WebWorker | self + importScripts | WebAPIs (å—é™), è¨ˆç®— |
| Unknown | ç„¡æ³•è­˜åˆ¥ | åŸºæœ¬ JavaScript |

### ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™

- **ç’°å¢ƒæª¢æ¸¬**: < 0.01ms (å–®æ¬¡)
- **åŠŸèƒ½æª¢æ¸¬**: < 1ms (å®Œæ•´æƒæ)
- **è¨˜æ†¶é«”ä½”ç”¨**: < 1KB (æ¨¡çµ„å¤§å°)
- **éŒ¯èª¤è™•ç†**: 100% è¦†è“‹ç‡

### ğŸ”§ Logger åŠŸèƒ½ç‰¹è‰²

1. **ç’°å¢ƒè‡ªé©æ‡‰**
   - Browser: å½©è‰²è¼¸å‡ºé—œé–‰ï¼Œè­¦å‘Šç´šåˆ¥
   - Node.js: å½©è‰²è¼¸å‡ºé–‹å•Ÿï¼ŒåµéŒ¯ç´šåˆ¥
   - WebWorker: çµæ§‹åŒ–è¼¸å‡ºï¼Œè³‡è¨Šç´šåˆ¥

2. **æ•ˆèƒ½ç›£æ§å·¥å…·**
```typescript
const perf = createPerformanceLogger('Store');
perf.time('action-processing');
// ... åŸ·è¡Œå‹•ä½œ ...
perf.timeEnd('action-processing'); // è¼¸å‡º: action-processing: 1.23ms
```

3. **æ¢ä»¶è¨˜éŒ„**
```typescript
devLog('é–‹ç™¼ç’°å¢ƒå°ˆç”¨è¨Šæ¯'); // åƒ…é–‹ç™¼ç’°å¢ƒ
prodError('ç”Ÿç”¢ç’°å¢ƒéŒ¯èª¤'); // åƒ…ç”Ÿç”¢ç’°å¢ƒ
```

### ğŸ“¦ ä¸‹ä¸€æ­¥

ä¸‹å€‹ä»»å‹™å°‡é€²è¡Œ **åŸºç¤ Action å‹åˆ¥** å¯¦ç¾ï¼Œå»ºç«‹ TsStoreX çš„ Action ç³»çµ±åŸºç¤ã€‚
